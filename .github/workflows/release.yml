name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-tarball:
    name: Publish Tarball
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v5

      - name: Disable man-db auto-update
        run: |
          echo "set man-db/auto-update false" | sudo debconf-communicate
          sudo dpkg-reconfigure man-db
          sudo rm -f /var/lib/man-db/auto-update

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool xsltproc docbook-xsl \
            libxpm-dev libx11-dev libxinerama-dev

      - name: Run autoreconf
        run: autoreconf --install

      - name: Configure
        run: ./configure

      - name: Build
        run: make

      - name: Generate tarball
        run:  make dist

      - name: Upload tarball
        uses: softprops/action-gh-release@v2
        with:
          files: "*.tar.gz"
